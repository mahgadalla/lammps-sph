log                ${dname}/log.lammps
echo               both
units              si
atom_style         meso
# periodic boundaries to have a correct density on the wall
# TODO: make density fixed for the choosen particles
boundary          p p p

variable          ndim equal 2
dimension         ${ndim}
include           vars.lmp

# create simulation box
variable           Lywall  equal ${Ly}+6*${dx}
variable           xcenter equal 0.5*${Lx}
variable           ycenter equal 0.5*${Lywall}

if ${ndim}==3 then &
"variable           zcenter equal 0.5*${Lz}" &
else &
"variable           zcenter equal 0.0" &

if ${ndim}==2 then &
"variable           pLz    equal  1.0e-3" &
"variable           nLz    equal  -1.0e-3" &
"region             box block 0.0 ${Lx}  0.0 ${Lywall} ${nLz} ${pLz} units box" &
else &
"region             box block 0.0 ${Lx}  0.0 ${Lywall} 0.0 ${Lz} units box"

# create box with two types of particles (water, gas)
create_box         2 box

# create gas particles
if ${ndim}==2 then &
"lattice            sq ${dx}" &
else &
"lattice            sc ${dx}"

create_atoms       ${g_type} region box

# create walls on the top and on the bottom
variable     ylow equal 3*${dx}
variable     yhi  equal ${Ly}+2.5*${dx}
region	     rflow block EDGE EDGE ${ylow} ${yhi} INF INF units box
group	     flow region rflow
group	     boundary subtract all flow
fix          wallim boundary setforce 0 0 0

set                 type ${d_type} meso_rho ${sph_rho_d}
set                 type ${g_type} meso_rho ${sph_rho_g}

compute            rho_peratom all meso_rho/atom
compute            colorgradient_peratom all meso_colorgradient/atom
compute         ie_atom all meso_e/atom

# do full time integration for all particles
fix                integrate_fix_full all meso

dump               dump_id all custom ${Nfreq} ${dname}/dump*.dat id type x y z vx vy vz &
c_rho_peratom c_colorgradient_peratom c_ie_atom

dump_modify        dump_id first yes sort id pad 8

#include            ${ndim}-image.lmp
variable           sph_mu  equal ${sph_eta_d}/${sph_rho_d}
include            settimestep.lmp

neighbor           3.0e-2 bin
neigh_modify       delay 0 every 1

communicate        single vel yes
set                group all meso_rho ${sph_rho_g}

pair_style         hybrid/overlay sph/rhosum_multiphase 1 sph/colorgradient 1 &
                   sph/taitwater/morris sph/surfacetension sph/heatconduction

pair_coeff         * * sph/rhosum_multiphase   ${h}

variable           cg_cutoff equal 3.0*${dx}
pair_coeff         ${d_type} ${d_type} sph/colorgradient ${cg_cutoff} 0
pair_coeff         ${g_type} ${d_type} sph/colorgradient ${cg_cutoff} ${alpha}
pair_coeff         ${g_type} ${g_type} sph/colorgradient ${cg_cutoff} 0

# harmonic mean of viscosities
variable           sph_eta_gd equal 2*${sph_eta_g}*${sph_eta_d}/(${sph_eta_d}+${sph_eta_g})
pair_coeff         ${g_type} ${d_type} sph/taitwater/morris ${sph_rho_g} ${sph_c_g} ${sph_eta_gd} ${h} ${rbackground}
pair_coeff         ${g_type} ${g_type} sph/taitwater/morris ${sph_rho_g} ${sph_c_g} ${sph_eta_g} ${h} ${rbackground}
pair_coeff         ${d_type} ${d_type} sph/taitwater/morris ${sph_rho_d} ${sph_c_d} ${sph_eta_d} ${h} ${rbackground}

pair_coeff         * * sph/surfacetension ${h}
pair_coeff         * * sph/heatconduction  0.02 ${h}

dump               dump_xyz all xyz ${Nfreq} ${dname}/data.xyz

variable            time equal step*dt
variable            natoms equal count(all)
thermo_style        custom step v_time v_natoms
thermo              10

timestep           ${dt}
variable          dseed equal 0.2
variable          x1 equal ${xcenter}-${dseed}
variable          x2 equal ${xcenter}+${dseed}
variable          y1 equal ${ylow}
variable          y2 equal ${ylow}+${dseed}
if ${ndim}==3 then &
"variable          z1 equal ${zcenter}-${dseed}" &
"variable          z2 equal ${zcenter}+${dseed}" &
"region	          rseed block ${x1} ${x2} ${y1} ${y2} ${z1} ${z2} units box" &
else &
"region	          rseed block ${x1} ${x2} ${y1} ${y2} EDGE EDGE units box"

group             gseed region rseed
set               group gseed type ${d_type}

set               type ${d_type} mass ${sph_mass_d}
set               type ${g_type} mass ${sph_mass_g}

variable          nprev equal 0.2/${dt}
# temperature of the wall
fix             fidtemp boundary setmesode 0.0

group              droplet type ${d_type}
variable           Ninsert equal 1000
variable           insert_every equal 1
variable           Tc equal 0.95
variable           Tt equal 0.97
variable           Cp equal 1.00
variable           dr equal 0.25*${dx}
fix                fdep droplet phase_change &
                   ${Tc} ${Tt} ${Cp} ${dr} ${sph_mass_d} &
                   ${h} ${g_type} ${d_type} ${insert_every} 123456 region box units box

variable bodyfy atom mass*${gy}
fix gravity droplet addforce 0.0 v_bodyfy 0.0 

compute            rg droplet gyration
variable vrg equal c_rg
variable vnd equal count(droplet)*${dx}^${ndim}
variable vmi equal (bound(droplet,ymin)-${ylow})/${dx}
variable vcm equal xcm(droplet,y)-${ylow}
fix extra all print 1 "${time} ${vrg} ${vnd} ${vmi} ${vcm}" file ${dname}/rg.dat screen no

set                 type ${g_type} meso_e 1.0
set                 type ${d_type} meso_e ${Tc}

echo            none
run               25000 pre no  post no every 1 &
"set               group boundary meso_e 1.0" &
"group droplet type ${d_type}" &
"if ${vmi}>2 then quit"
