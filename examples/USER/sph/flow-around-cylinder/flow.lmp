log                ${dname}/log.lammps
echo               both
variable           ndim equal 3
dimension          ${ndim}
units              si
atom_style         meso
include            vars.lmp
# periodic boundaries to have a correct density on the wall
# TODO: make density fixed for the choosen particles
boundary          p p p
# create simulation box
if ${ndim}==2 then &
"variable           pLz    equal  1.0e-3" &
"variable           nLz    equal  -1.0e-3" &
"region             box block 0.0 ${Lx}  0.0 ${Ly} ${nLz} ${pLz} units box" &
else &
"region             box block 0.0 ${Lx}  0.0 ${Ly} 0 ${Lz} units box"
variable           xcenter equal 0.5*${Lx}
variable           ycenter equal 0.5*${Ly}

# create box with two types of particles (flow and wall)
create_box         2 box

# create gas particles
if ${ndim}==3 then &
"lattice            sc ${dx}" &
else &
"lattice            sq ${dx}"
create_atoms       ${g_type} region box

# set mass of the particles
set               type ${d_type} mass ${sph_mass_d}
set               type ${g_type} mass ${sph_mass_g}

compute            rho_peratom all meso_rho/atom

# do full time integration for all particles
fix                integrate_fix_full all meso

dump               dump_id all custom ${Nfreq} ${dname}/dump*.dat id type x y z vx vy vy fx fy fz c_rho_peratom
dump_modify        dump_id first yes sort id pad 8

variable           sph_mu  equal ${sph_eta}/${sph_rho}
include            settimestep.lmp

communicate        single vel yes
set                group all meso_rho ${sph_rho}

pair_style         hybrid/overlay sph/rhosum_multiphase 1 sph/taitwater/multiphase
pair_coeff         * * sph/rhosum_multiphase   ${h}

# harmonic mean of viscosities
pair_coeff         * * sph/taitwater/multiphase ${sph_rho} ${sph_c} ${sph_eta} ${h} 1 0

neighbor           3e-6 bin
neigh_modify       delay 0 every 1

dump               dump_dcd all dcd ${Nfreq} ${dname}/data.dcd
dump_modify        dump_dcd sort id

# create cylinder
region             rcylinder cylinder z ${xcenter} ${ycenter} ${cyl_r} EDGE EDGE units box
set	           region rcylinder type ${d_type}
group              gcylinder region rcylinder
group	           flow subtract all gcylinder

# fix wall particles
fix                wallim gcylinder setforce 0 0 0
write_restart      ${dname}/droplet.restart

set                 type ${d_type} meso_rho ${sph_rho}
set                 type ${g_type} meso_rho ${sph_rho}

variable bodyfx atom mass*${gx}
fix reverce_periodic flow addforce v_bodyfx 0.0 0.0 

variable            time equal step*dt
thermo_style        custom step v_time
thermo              10

timestep           ${dt}
run               1000

# end line
variable           xend equal 0.9*${Lx}
region             rend block ${xend} ${Lx} 0 ${Ly} EDGE EDGE units box
fix av_vend all ave/spatial 1 ${Nfreq} ${Nfreq} &
y center 0.01 vx region rend file vend.av ave running units reduced

# center line
variable           x1 equal 0.45*${Lx}
variable           x2 equal 0.55*${Lx}
region             rcenter block ${x1} ${x2} 0 ${Ly} EDGE EDGE units box
fix av_vcen all ave/spatial 1 ${Nfreq} ${Nfreq} &
y center 0.01 vx region rcenter file vcen.av ave running units reduced

run              10000